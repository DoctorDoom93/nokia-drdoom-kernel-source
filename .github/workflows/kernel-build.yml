name: Build Nokia 5.4 Kernel

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-kernel:
    runs-on: ubuntu-24.04
    env:
      KERNEL_DIR: ${{ github.workspace }}
      ARCH: arm64
      CROSS_COMPILE: aarch64-linux-gnu-
      CC: gcc

    steps:
    - name: Checkout source
      uses: actions/checkout@v3
      with:
        submodules: true

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          git bc bison flex libssl-dev libelf-dev build-essential \
          device-tree-compiler gcc-aarch64-linux-gnu python3

    - name: Force python3 as default
      run: |
        sudo update-alternatives --install /usr/bin/python python /usr/bin/python3 1

    - name: Patch gcc-wrapper.py for Python 3
      run: |
        sed -i 's/print \(.*\)/print(\1)/g' ${{ github.workspace }}/scripts/gcc-wrapper.py

    - name: Configure kernel
      run: |
        cd $KERNEL_DIR
        make vendor/bengal_drdoom_defconfig

    - name: Build kernel
      run: |
        cd $KERNEL_DIR
        make -j$(nproc) CC=$CC ARCH=$ARCH CROSS_COMPILE=$CROSS_COMPILE \
          KCFLAGS="-Wno-error=array-bounds"

    - name: Archive built kernel and DTBs
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: nokia5.4-kernel
        path: |
          ${{ github.workspace }}/arch/arm64/boot/Image
          ${{ github.workspace }}/arch/arm64/boot/dts/vendor/*.dtb
        retention-days: 7
        if-no-files-found: warn
